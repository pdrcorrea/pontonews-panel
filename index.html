<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Notícias • Vyre</title>

<link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;600;800;900&display=swap" rel="stylesheet"/>

<style>
:root{
  --header: linear-gradient(180deg,#2f6f9d 0%,#184c75 55%,#0f3b5e 100%);
  --bg: radial-gradient(1200px 900px at 25% 10%, rgba(87,184,231,.22), rgba(10,46,62,0) 60%),
        radial-gradient(900px 700px at 75% 80%, rgba(52,198,208,.14), rgba(6,18,24,0) 65%),
        radial-gradient(1400px 1100px at 50% 55%, #0a2232 0%, #081423 62%, #040a0f 100%);
  --chipText:#0f172a;
  --chipBg: rgba(255,255,255,.88);
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  font-family:Inter,system-ui;
  background:var(--bg);
  display:grid;
  place-items:center;
  padding:20px;
}
.panel{
  width:min(1500px,96vw);
  height:calc(100vh - 40px);
  background:#fff;
  border-radius:18px;
  overflow:hidden;
  box-shadow:0 18px 60px rgba(2,10,23,.18);
  display:flex;
  flex-direction:column;
}
.header{
  padding:14px 22px;
  background:var(--header);
  color:#fff;
  display:flex;
  justify-content:space-between;
  align-items:center;
}
.h-left{display:flex;gap:14px;align-items:center}
.iconBadge{width:44px;height:44px;border-radius:14px;display:grid;place-items:center;background:rgba(255,255,255,.1);}
.title{font-size:28px;font-weight:900;letter-spacing:.06em}
.sub{font-size:12px;font-weight:800;letter-spacing:.14em;opacity:.9}
.h-right{text-align:right}
.clock{font-size:52px;font-weight:900}
.status{
  margin-top:6px;
  display:inline-flex; align-items:center; gap:8px;
  padding:6px 12px; border-radius:999px;
  background:rgba(255,255,255,.14);
  font-size:12px; font-weight:900;
}
.dot{width:10px;height:10px;border-radius:50%;background:#22c55e;}
.off{background:#ef4444}

.substrip{
  background:#f3f7ff;
  padding:10px 22px;
  font-size:12px;
  font-weight:900;
  letter-spacing:.14em;
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:12px;
}
.substrip span{white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.diag{letter-spacing:normal;font-weight:800;color:#0f172a;opacity:.75}

.hero{position:relative;flex:1;overflow:hidden;}
.hero img{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;}
.overlay{position:absolute;inset:0;background:linear-gradient(180deg,transparent 40%,rgba(0,0,0,.85));}
.content{position:absolute;bottom:20px;left:22px;right:22px;color:#fff;}
.headline{font-size:52px;font-weight:900;line-height:1.08;max-width:1200px;}
.meta{margin-top:14px;display:flex;gap:10px;flex-wrap:wrap;align-items:center;}
.chip{
  background:var(--chipBg); color:var(--chipText);
  padding:8px 12px; border-radius:999px;
  font-size:12px; font-weight:900;
  display:flex; align-items:center; gap:8px;
}
.chip img{width:18px;height:18px;object-fit:contain;}
.footer{padding:10px 22px;display:flex;justify-content:flex-end;}
.footer img{height:22px;opacity:.75}

@media (max-aspect-ratio: 4/5){
  body{padding:14px}
  .panel{width:min(920px,96vw)}
  .headline{font-size:44px}
  .clock{font-size:46px}
}
</style>
</head>

<body>
<section class="panel">

  <div class="header">
    <div class="h-left">
      <div class="iconBadge"><span class="material-icons-outlined">newspaper</span></div>
      <div>
        <div class="title">NOTÍCIAS</div>
        <div class="sub">LOCAL • ES • BR</div>
      </div>
    </div>
    <div class="h-right">
      <div class="clock" id="clock">--:--</div>
      <div class="status">
        <span class="dot" id="dot"></span>
        <span id="statusText">Online</span>
      </div>
    </div>
  </div>

  <div class="substrip">
    <span>MANCHETE ATUAL</span>
    <span id="scopeLabel">AGORA • BRASIL</span>
    <span class="diag" id="diag">Iniciando…</span>
  </div>

  <div class="hero">
    <img id="image" alt="Imagem da notícia"/>
    <div class="overlay"></div>
    <div class="content">
      <div class="headline" id="title">Carregando…</div>
      <div class="meta">
        <div class="chip">
          <img id="logo" alt="Logo da fonte"/>
          <span id="source">Fonte</span>
        </div>
        <div class="chip" id="date"></div>
      </div>
    </div>
  </div>

  <div class="footer">
    <img src="./assets/logo-pontoview.png" alt="PontoView" onerror="this.style.display='none'"/>
  </div>

</section>

<script>
/* ====== TROQUE AQUI PELO SEU LINK workers.dev ====== */
const WORKER_URL = "https://pontoview-api.pedrhc258.workers.dev/";

/* feeds */
const FEEDS = [
  { name: "Agência Brasil", url: "https://agenciabrasil.ebc.com.br/rss/ultimasnoticias/feed.xml" },
  { name: "Brasil de Fato", url: "https://www.brasildefato.com.br/feed/" }
];

const SAFE_MODE = 1;
const WORKER_TTL_HOURS = 6;
const UI_REFRESH_HOURS = 6;
const ITEMS_PER_FEED = 18;
const ROTATE_EVERY_MS = 15000;
const MAX_ITEMS = 30;

const FALLBACK_IMG = "https://images.unsplash.com/photo-1504711432869-0df30a7e04ad?auto=format&fit=crop&w=1600&q=70";

const titleEl = document.getElementById("title");
const sourceEl = document.getElementById("source");
const imgEl = document.getElementById("image");
const logoEl = document.getElementById("logo");
const dateEl = document.getElementById("date");
const diagEl = document.getElementById("diag");
const scopeLabelEl = document.getElementById("scopeLabel");

/* relógio */
const clock = document.getElementById("clock");
setInterval(() => {
  clock.textContent = new Date().toLocaleTimeString("pt-BR", { hour: "2-digit", minute: "2-digit" });
}, 1000);

/* online/offline */
const statusText = document.getElementById("statusText");
const dot = document.getElementById("dot");
function updateStatus() {
  if (navigator.onLine) { statusText.textContent = "Online"; dot.classList.remove("off"); }
  else { statusText.textContent = "Offline"; dot.classList.add("off"); }
}
window.addEventListener("online", updateStatus);
window.addEventListener("offline", updateStatus);
updateStatus();

/* helpers */
function proxy(url) {
  if (!url) return null;
  const clean = String(url).trim();
  if (!clean || clean === "null" || clean === "undefined") return null;
  const noProto = clean.replace(/^https?:\/\//i, "");
  return "https://wsrv.nl/?url=" + encodeURIComponent(noProto) + "&w=1600&fit=cover&output=webp";
}
function setHeroImage(url){
  const finalUrl = proxy(url) || FALLBACK_IMG;
  imgEl.src = finalUrl;
  imgEl.onerror = () => { if (imgEl.src !== FALLBACK_IMG) imgEl.src = FALLBACK_IMG; };
}
function faviconForLink(link){
  try{
    const domain = new URL(link).hostname.replace(/^www\./,"");
    return `https://www.google.com/s2/favicons?domain=${encodeURIComponent(domain)}&sz=64`;
  }catch{ return ""; }
}
function fmtPublished(iso){
  const d = new Date(iso);
  if (isNaN(d.getTime())) return "";
  return d.toLocaleString("pt-BR", { day:"2-digit", month:"2-digit", year:"numeric", hour:"2-digit", minute:"2-digit" }).replace(",", " •");
}
function dateMs(v){ const t = new Date(v).getTime(); return isNaN(t) ? 0 : t; }
function dedupeByLink(list){
  const s = new Set(); const out=[];
  for (const it of list){
    const k = it.link || it.title;
    if (!k || s.has(k)) continue;
    s.add(k); out.push(it);
  }
  return out;
}

async function fetchFromWorker(feed){
  const api =
    `${WORKER_URL}?feed=${encodeURIComponent(feed.url)}` +
    `&ttlHours=${WORKER_TTL_HOURS}&safe=${SAFE_MODE}&limit=${ITEMS_PER_FEED}`;
  const res = await fetch(api, { cache: "no-store" });
  const data = await res.json();
  if (!res.ok) throw new Error(`HTTP ${res.status}`);
  if (!data || data.ok !== true) throw new Error(`Resposta inválida do Worker`);
  return (data.items||[]).map(it => ({
    title: (it.title||"").trim(),
    link: it.link||"",
    pubDate: it.pubDate||"",
    image: it.image||"",
    sourceName: feed.name,
    logo: faviconForLink(it.link||"")
  }));
}

let NEWS = [];
let idx = 0;
let rotateTimer = null;

function render(){
  if (!NEWS.length) return;
  const item = NEWS[idx % NEWS.length];
  idx++;

  titleEl.textContent = item.title || "Notícia";
  sourceEl.textContent = item.sourceName || "Fonte";

  if (item.logo){ logoEl.src = item.logo; logoEl.style.display = "block"; }
  else { logoEl.style.display = "none"; }

  const pub = fmtPublished(item.pubDate);
  if (pub){ dateEl.textContent = pub; dateEl.style.display = "flex"; }
  else { dateEl.textContent = ""; dateEl.style.display = "none"; }

  scopeLabelEl.textContent = "AGORA • BRASIL";
  setHeroImage(item.image);
}

async function loadNews(){
  diagEl.textContent = "Carregando feeds…";

  if (!WORKER_URL || WORKER_URL.includes("COLE_AQUI")){
    diagEl.textContent = "Falta configurar WORKER_URL (workers.dev).";
    titleEl.textContent = "Configure o WORKER_URL";
    setHeroImage(null);
    return;
  }

  const results = await Promise.allSettled(FEEDS.map(fetchFromWorker));
  let all = [];
  const errors = [];

  for (const r of results){
    if (r.status === "fulfilled") all = all.concat(r.value);
    else errors.push(String(r.reason?.message || r.reason || "erro"));
  }

  all = dedupeByLink(all).sort((a,b)=>dateMs(b.pubDate)-dateMs(a.pubDate)).slice(0, MAX_ITEMS);

  if (!all.length){
    diagEl.textContent = "Sem itens. Erros: " + (errors[0] || "desconhecido");
    titleEl.textContent = "Sem notícias no momento";
    sourceEl.textContent = "Fonte";
    logoEl.style.display = "none";
    dateEl.style.display = "none";
    setHeroImage(null);
    return;
  }

  NEWS = all;
  idx = 0;

  diagEl.textContent = `OK • ${NEWS.length} notícias • cache ${WORKER_TTL_HOURS}h`;
  render();

  if (rotateTimer) clearInterval(rotateTimer);
  rotateTimer = setInterval(render, ROTATE_EVERY_MS);
}

loadNews();
setInterval(loadNews, UI_REFRESH_HOURS * 60 * 60 * 1000);
</script>
</body>
</html>
