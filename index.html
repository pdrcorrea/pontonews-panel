<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>PontoView • Notícias</title>

<link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;600;800;900&display=swap" rel="stylesheet"/>

<link rel="stylesheet" href="./css/pv-base.css">

<style>
  /* Ajustes do painel Notícias (só o conteúdo/hero) */
  :root{
    /* se quiser igualar 100% o header aos outros: não mexa nisso */
    --pvHeaderGrad: linear-gradient(180deg,#2f6f9d 0%,#184c75 55%,#0f3b5e 100%);
  }

  .hero{
    position:relative;
    width:100%;
    height:100%;
    min-height:0;
    overflow:hidden;
    background:
      radial-gradient(1200px 800px at 40% 30%, rgba(17,24,39,.25), rgba(17,24,39,0) 60%),
      linear-gradient(180deg, #0b1220 0%, #111827 100%);
  }
  .hero img{
    position:absolute;
    inset:0;
    width:100%;
    height:100%;
    object-fit:cover;
    filter:saturate(1.02) contrast(1.03);
    transform:scale(1.01);
  }
  .overlay{
    position:absolute;
    inset:0;
    background:
      linear-gradient(180deg, rgba(0,0,0,.20) 0%, rgba(0,0,0,.70) 62%, rgba(0,0,0,.88) 100%),
      radial-gradient(900px 520px at 30% 75%, rgba(0,0,0,.55), rgba(0,0,0,0) 65%);
  }
  .content{
    position:absolute;
    inset:auto var(--pad) var(--pad);
    bottom: var(--pad);
    color:#fff;
    display:flex;
    flex-direction:column;
    gap: 14px;
    max-width: min(1200px, 92vw);
  }
  .headline{
    font-size: clamp(30px, 4.4vw, 70px);
    font-weight:900;
    line-height:1.05;
    letter-spacing:-.01em;
    text-shadow: 0 8px 24px rgba(0,0,0,.35);
  }
  .metaRow{
    display:flex;
    gap:10px;
    flex-wrap:wrap;
    align-items:center;
  }
  .chip{
    background:rgba(255,255,255,.92);
    color:#0f172a;
    padding:10px 12px;
    border-radius:999px;
    font-size: clamp(12px, 1.1vw, 16px);
    font-weight:900;
    display:flex;
    align-items:center;
    gap:10px;
    box-shadow: 0 10px 26px rgba(0,0,0,.15);
  }
  .sourceIcon{
    width:26px;height:26px;border-radius:999px;
    background:rgba(15,23,42,.10);
    border:1px solid rgba(15,23,42,.10);
    display:grid; place-items:center;
    overflow:hidden;
    flex:0 0 auto;
  }
  .sourceIcon img{width:18px;height:18px;object-fit:contain;display:block}
</style>
</head>

<body>
  <div class="pvPage">
    <section class="pvShell">

      <!-- HEADER -->
      <header class="pvHeader">
        <div class="pvHeaderLeft">
          <div class="pvIconBadge" aria-hidden="true">
            <span class="material-icons-outlined">newspaper</span>
          </div>
          <div class="pvTitles">
            <h1 class="pvTitle">NOTÍCIAS</h1>
            <div class="pvSubtitle" id="subtitle">LOCAL • ES • BR</div>
          </div>
        </div>

        <div class="pvHeaderRight">
          <div class="pvClock" id="clock">--:--</div>
        </div>
      </header>

      <!-- SUBBAR -->
      <div class="pvSubbar">
        <div class="pvSubLeft" id="subLeft">MANCHETE ATUAL</div>
        <div class="pvSubRight">
          <div class="pvSubLeft" style="font-size:var(--t-sub); font-weight:900; letter-spacing:.12em; opacity:.9;" id="scopeLabel">
            AGORA • BRASIL
          </div>
          <div class="pvPill" id="pillOnline">
            <span class="pvDot" id="dot"></span>
            <span id="statusText">Online</span>
          </div>
        </div>
      </div>

      <!-- CONTENT -->
      <main class="pvContent">
        <section class="pvCard">
          <div class="hero">
            <img id="image" alt="Imagem da notícia" />
            <div class="overlay"></div>

            <div class="content">
              <div class="headline" id="title">Carregando…</div>

              <div class="metaRow">
                <div class="chip">
                  <span class="sourceIcon" id="sourceIcon">
                    <img id="favicon" alt="" />
                  </span>
                  <span id="source">Fonte</span>
                </div>

                <div class="chip" id="date"></div>
              </div>
            </div>
          </div>
        </section>
      </main>

      <!-- FOOTER -->
      <footer class="pvFooter">
        <div class="pvFooterLeft"></div>
        <div class="pvFooterRight">
          <img class="pvLogo" src="./assets/logo-pontoview.png" alt="PontoView"/>
        </div>
      </footer>

    </section>
  </div>

<script>
/* ========= CONFIG ========= */
const WORKER_API = "https://pontoview-api.pedrhc258.workers.dev/api/news";
const UI_ROTATE_MS = 15000;
const UI_REFRESH_HOURS = 6;
const LIMIT = 30;
const SAFE = 1;

const FALLBACK_IMG = "https://images.unsplash.com/photo-1504711432869-0df30a7e04ad?auto=format&fit=crop&w=1600&q=70";

/* ===== CLOCK ===== */
const clock = document.getElementById("clock");
function tickClock(){
  clock.textContent = new Date().toLocaleTimeString("pt-BR",{hour:"2-digit",minute:"2-digit"});
}
tickClock();
setInterval(tickClock, 1000);

/* ===== ONLINE / OFFLINE ===== */
const statusText = document.getElementById("statusText");
const dot = document.getElementById("dot");
function updateStatus(){
  if (navigator.onLine){
    statusText.textContent = "Online";
    dot.classList.remove("off");
  } else {
    statusText.textContent = "Offline";
    dot.classList.add("off");
  }
}
window.addEventListener("online", updateStatus);
window.addEventListener("offline", updateStatus);
updateStatus();

/* ===== HELPERS ===== */
function fmtPublished(str){
  if (!str) return "";
  const d = new Date(str);
  if (Number.isNaN(d.getTime())) return "";
  const dd = String(d.getDate()).padStart(2,"0");
  const mm = String(d.getMonth()+1).padStart(2,"0");
  const yyyy = d.getFullYear();
  const hh = String(d.getHours()).padStart(2,"0");
  const mi = String(d.getMinutes()).padStart(2,"0");
  return `${dd}/${mm}/${yyyy} • ${hh}:${mi}`;
}
function extractSource(url=""){
  try{
    const host = new URL(url).hostname.replace("www.","");
    const base = host.split(".")[0] || "FONTE";
    return base.toUpperCase();
  }catch{ return "FONTE"; }
}
function faviconForLink(url=""){
  try{
    const u = new URL(url);
    return `https://www.google.com/s2/favicons?domain=${u.hostname}&sz=64`;
  }catch{ return ""; }
}
function imgProxy(url){
  if(!url) return null;
  const clean = String(url).trim();
  if(!clean) return null;
  if(clean.includes("wsrv.nl/?url=")) return clean;
  const noProto = clean.replace(/^https?:\/\//i,"");
  return "https://wsrv.nl/?url=" + encodeURIComponent(noProto) + "&w=1600&fit=cover&output=webp";
}

/* ===== DATA FLOW ===== */
let NEWS = [];
let idx = 0;
let rotateTimer = null;

async function fetchFromWorker(){
  const seed = Date.now();
  const url = `${WORKER_API}?ttlHours=${UI_REFRESH_HOURS}&limit=${LIMIT}&safe=${SAFE}&seed=${seed}`;
  const res = await fetch(url, { cache:"no-store" });
  const data = await res.json();
  if(!res.ok || !data || data.ok !== true) throw new Error("Worker inválido");
  const items = Array.isArray(data.items) ? data.items : [];
  return items.map(it => ({
    title: (it.title || "").trim() || "Notícia",
    link: it.link || "",
    pubDate: it.pubDate || "",
    image: it.image || "",
    sourceName: extractSource(it.link || ""),
    favicon: faviconForLink(it.link || "")
  }));
}

function setHeroImage(url){
  const imgEl = document.getElementById("image");
  const finalUrl = imgProxy(url) || FALLBACK_IMG;
  imgEl.src = finalUrl;

  const pre = new Image();
  pre.onerror = ()=>{ if(imgEl.src !== FALLBACK_IMG) imgEl.src = FALLBACK_IMG; };
  pre.src = finalUrl;
}
document.getElementById("image").addEventListener("error", ()=>{
  const imgEl = document.getElementById("image");
  if(imgEl.src !== FALLBACK_IMG) imgEl.src = FALLBACK_IMG;
});

function renderCurrent(){
  if(!NEWS.length) return;
  const item = NEWS[idx % NEWS.length];
  idx++;

  document.getElementById("title").textContent = item.title || "Notícia";
  document.getElementById("source").textContent = item.sourceName || "FONTE";

  const fav = document.getElementById("favicon");
  const iconWrap = document.getElementById("sourceIcon");
  if(item.favicon){
    fav.src = item.favicon;
    iconWrap.style.display = "grid";
  } else {
    iconWrap.style.display = "none";
  }

  const pub = fmtPublished(item.pubDate);
  const dateEl = document.getElementById("date");
  dateEl.textContent = pub || "";
  dateEl.style.display = pub ? "flex" : "none";

  document.getElementById("scopeLabel").textContent = "AGORA • BRASIL";
  setHeroImage(item.image);
}

async function refreshAll(){
  try{
    NEWS = await fetchFromWorker();
    if(!NEWS.length) throw new Error("Sem itens");
    idx = Math.floor(Math.random() * NEWS.length);

    renderCurrent();

    if(rotateTimer) clearInterval(rotateTimer);
    rotateTimer = setInterval(renderCurrent, UI_ROTATE_MS);
  }catch(e){
    document.getElementById("title").textContent = "Sem notícias no momento";
    document.getElementById("source").textContent = "PontoView";
    document.getElementById("date").style.display = "none";
    document.getElementById("scopeLabel").textContent = "AGORA • BRASIL";
    setHeroImage(FALLBACK_IMG);
    console.error(e);
  }
}

refreshAll();
setInterval(refreshAll, UI_REFRESH_HOURS * 60 * 60 * 1000);
</script>
</body>
</html>
