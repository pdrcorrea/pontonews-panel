<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>PontoView • Notícias</title>

<link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;600;800;900&display=swap" rel="stylesheet"/>

<style>
  :root{
    /* ===== PONTO VIEW THEME (igual padrão) ===== */
    --header: linear-gradient(180deg,#2f6f9d 0%,#184c75 55%,#0f3b5e 100%);
    --bg: radial-gradient(1200px 900px at 25% 10%, rgba(87,184,231,.22), rgba(10,46,62,0) 60%),
          radial-gradient(900px 700px at 75% 80%, rgba(52,198,208,.14), rgba(6,18,24,0) 65%),
          radial-gradient(1400px 1100px at 50% 55%, #0a2232 0%, #081423 62%, #040a0f 100%);
    --card:#ffffff;
    --line:#e6edf7;
    --chip:#f3f7ff;
    --muted:#6b7788;
    --ink:#0e1b2a;

    --radius:22px;
    --shadow:0 18px 60px rgba(2,10,23,.18);

    /* Safe padding padrão (igual painéis clima/ônibus) */
    --safe: clamp(14px, 2.2vw, 32px);

    /* Tipos responsivos */
    --t-title: clamp(22px, 2.1vw, 34px);
    --t-sub:   clamp(12px, 1.05vw, 16px);
    --t-clock: clamp(42px, 4.2vw, 78px);

    --t-headline: clamp(30px, 4.4vw, 70px);

    /* footer meta */
    --t-foot: clamp(11px, 0.95vw, 13px);
  }

  *{box-sizing:border-box}
  html,body{height:100%}

  body{
    margin:0;
    font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    background:var(--bg);
    color:var(--ink);
    overflow:hidden;
  }

  /* ===== FULLSCREEN COM SAFE PADDING ===== */
  .frame{
    width:100vw;
    height:100vh;
    padding:var(--safe);
    display:flex;
  }

  .panel{
    width:100%;
    height:100%;
    background:var(--card);
    border-radius:var(--radius);
    overflow:hidden;
    box-shadow:var(--shadow);
    display:flex;
    flex-direction:column;
    min-height:0;

    /* ✅ animação suave de entrada (substitui o fade antigo) */
    opacity:0;
    transform: translateY(10px);
    animation: panelIn 700ms cubic-bezier(.22,1,.36,1) forwards;
  }
  @keyframes panelIn{ to{opacity:1; transform:none;} }

  /* ===== HEADER ===== */
  .header{
    padding: clamp(14px, 1.4vw, 22px) clamp(16px, 1.8vw, 26px);
    background:var(--header);
    color:#fff;
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:16px;
    border-bottom:1px solid rgba(255,255,255,.12);
    min-width:0;
  }

  .h-left{display:flex;gap:14px;align-items:center;min-width:0}
  .iconBadge{
    width:clamp(44px, 3.2vw, 62px);
    height:clamp(44px, 3.2vw, 62px);
    border-radius:16px;
    display:grid;
    place-items:center;
    background:rgba(255,255,255,.10);
    border:1px solid rgba(255,255,255,.22);
    box-shadow: inset 0 1px 0 rgba(255,255,255,.18);
    flex:0 0 auto;
  }
  .iconBadge .material-icons-outlined{font-size:clamp(22px, 2vw, 30px); opacity:.95}

  .titles{display:flex;flex-direction:column;gap:6px;min-width:0}
  .title{
    font-size:var(--t-title);
    font-weight:900;
    letter-spacing:.06em;
    text-transform:uppercase;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }
  .sub{
    font-size:var(--t-sub);
    font-weight:800;
    letter-spacing:.14em;
    text-transform:uppercase;
    opacity:.92;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }

  .h-right{
    text-align:right;
    display:flex;
    flex-direction:column;
    gap:10px;
    align-items:flex-end;
    min-width:max-content;
  }
  .clock{
    font-size:var(--t-clock);
    font-weight:900;
    line-height:1;
    letter-spacing:.02em;
    font-variant-numeric: tabular-nums;
  }

  /* ===== SUBBAR ===== */
  .subbar{
    background:var(--chip);
    border-bottom:1px solid var(--line);
    padding: 10px clamp(16px, 1.8vw, 26px);
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:12px;
    min-width:0;
  }
  .subbarLeft{
    font-size:var(--t-sub);
    font-weight:900;
    letter-spacing:.14em;
    text-transform:uppercase;
    color:#1c2c41;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }
  .subbarRight{
    display:flex;
    gap:10px;
    align-items:center;
    justify-content:flex-end;
    min-width:0;
    white-space:nowrap;
  }

  .pill{
    display:inline-flex;
    align-items:center;
    gap:10px;
    padding:8px 12px;
    border-radius:999px;
    background:rgba(255,255,255,.78);
    border:1px solid rgba(15,23,42,.08);
    color:#0f172a;
    font-weight:900;
    font-size:clamp(12px, 1.05vw, 16px);
  }
  .dot{
    width:10px;height:10px;border-radius:50%;
    background:#22c55e;
    box-shadow:0 0 0 0 rgba(34,197,94,.55);
    animation:pulse 1.6s infinite;
  }
  .dot.off{background:#ef4444; animation:none; box-shadow:none;}
  @keyframes pulse{
    0%{box-shadow:0 0 0 0 rgba(34,197,94,.50)}
    70%{box-shadow:0 0 0 10px rgba(34,197,94,0)}
    100%{box-shadow:0 0 0 0 rgba(34,197,94,0)}
  }

  /* ===== HERO ===== */
  .hero{
    position:relative;
    flex:1 1 auto;
    min-height:0;
    overflow:hidden;

    /* ✅ fundo agradável mesmo sem imagem */
    background:
      radial-gradient(1200px 760px at 35% 25%, rgba(56,189,248,.18), rgba(0,0,0,0) 60%),
      radial-gradient(900px 640px at 75% 80%, rgba(34,197,94,.10), rgba(0,0,0,0) 60%),
      linear-gradient(180deg, #0b1220 0%, #0a1b2e 45%, #0b1020 100%);
  }

  .hero::before{
    content:"";
    position:absolute;
    inset:0;
    pointer-events:none;
    background:
      radial-gradient(2px 2px at 20% 30%, rgba(255,255,255,.16) 0 50%, transparent 55%),
      radial-gradient(2px 2px at 65% 20%, rgba(255,255,255,.12) 0 50%, transparent 55%),
      radial-gradient(2px 2px at 80% 70%, rgba(255,255,255,.10) 0 50%, transparent 55%),
      radial-gradient(2px 2px at 35% 75%, rgba(255,255,255,.10) 0 50%, transparent 55%);
    opacity:.35;
  }

  .hero img{
    position:absolute;
    inset:0;
    width:100%;
    height:100%;
    object-fit:cover;
    filter:saturate(1.02) contrast(1.03);
    transform:scale(1.01);
    opacity:.78;
    transition: opacity 220ms ease;
  }
  .hero.noimg img{ opacity:0; }

  .overlay{
    position:absolute;
    inset:0;
    background:
      linear-gradient(180deg, rgba(0,0,0,.10) 0%, rgba(0,0,0,.55) 58%, rgba(0,0,0,.78) 100%),
      radial-gradient(900px 520px at 30% 75%, rgba(0,0,0,.35), rgba(0,0,0,0) 65%);
  }

  .content{
    position:absolute;
    inset:auto clamp(16px, 1.8vw, 26px) clamp(16px, 1.8vw, 22px);
    bottom: clamp(18px, 2.0vw, 26px);
    color:#fff;
    display:flex;
    flex-direction:column;
    gap: 10px;
    max-width: min(1280px, 92vw);

    /* ✅ crossfade */
    opacity:1;
    transform:none;
    transition: opacity 280ms ease, transform 280ms ease;
  }
  .content.fadeOut{
    opacity:0;
    transform: translateY(6px);
  }

  .headline{
    font-size:var(--t-headline);
    font-weight:900;
    line-height:1.05;
    letter-spacing:-.01em;
    text-shadow: 0 8px 24px rgba(0,0,0,.35);
  }

  /* ===== FOOTER ===== */
  .footer{
    flex:0 0 auto;
    height: clamp(46px, 5.4vh, 72px);
    display:flex;
    align-items:center;
    justify-content:space-between;
    padding: 10px clamp(16px, 1.8vw, 26px);
    border-top:1px solid var(--line);
    background: transparent;
    gap: 14px;
    min-width:0;
  }

  .footerLeft{
    display:flex;
    align-items:center;
    gap:10px;
    min-width:0;
    overflow:hidden;
  }

  .siteBubble{
    width:26px;
    height:26px;
    border-radius:999px;
    background: rgba(255,255,255,.90);
    border:1px solid rgba(15,23,42,.10);
    display:grid;
    place-items:center;
    overflow:hidden;
    flex:0 0 auto;
    box-shadow: 0 8px 18px rgba(0,0,0,.06);
  }
  .siteBubble img{
    width:16px;height:16px;object-fit:contain;display:block;
  }

  .footMeta{
    font-size:var(--t-foot);
    font-weight:900;
    letter-spacing:.10em;
    text-transform:uppercase;
    color:#31445f;
    opacity:.92;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }

  .footerRight{
    display:flex;
    align-items:center;
    justify-content:flex-end;
    flex:0 0 auto;
  }
  .footerRight img{
    height: clamp(16px, 2.4vh, 22px);
    opacity:.80;
    display:block;
  }

  @media (max-aspect-ratio: 10/16){
    .content{max-width: 92vw;}
    .headline{letter-spacing:-.02em;}
  }
</style>
</head>

<body>
  <div class="frame">
    <section class="panel">

      <!-- HEADER -->
      <div class="header">
        <div class="h-left">
          <div class="iconBadge" aria-hidden="true">
            <span class="material-icons-outlined">newspaper</span>
          </div>
          <div class="titles">
            <div class="title">NOTÍCIAS</div>
          </div>
        </div>
        <div class="h-right">
          <div class="clock" id="clock">--:--</div>
        </div>
      </div>

      <!-- SUBBAR -->
      <div class="subbar">
        <div class="subbarLeft" id="subLeft">MANCHETE ATUAL</div>

        <div class="subbarRight">
          <div class="pill" id="pillOnline">
            <span class="dot" id="dot"></span>
            <span id="statusText">Online</span>
          </div>
        </div>
      </div>

      <!-- HERO -->
      <div class="hero" id="hero">
        <img id="image" alt="Imagem da notícia" />
        <div class="overlay"></div>

        <div class="content">
          <div class="headline" id="title">Carregando…</div>
        </div>
      </div>

      <!-- FOOTER -->
      <div class="footer">
        <div class="footerLeft" aria-label="Fonte e data">
          <span class="siteBubble" aria-hidden="true">
            <img id="favicon" alt="" />
          </span>
          <div class="footMeta" id="footMeta">FONTE • — • —</div>
        </div>

        <div class="footerRight">
          <img src="./assets/logo-pontoview.png" alt="PontoView"/>
        </div>
      </div>

    </section>
  </div>

<script>
/* ========= CONFIG ========= */
const WORKER_API = "https://pontoview-api.pedrhc258.workers.dev/api/news";
const UI_ROTATE_MS = 15000;      // se quiser só no refresh: coloque 0
const UI_REFRESH_HOURS = 6;
const LIMIT = 60;
const SAFE = 1;

/* ===== FILTROS ===== */
const MAX_DAYS = 3;

const ALLOWED_DOMAINS = [
  "es.gov.br",
  "vitoria.es.gov.br",
  "linhares.es.gov.br",
  "colatina.es.gov.br",
  "cachoeiro.es.gov.br",
  "agazeta.com.br",
  "folhavitoria.com.br",
  "simnoticias.com.br",
  "agenciabrasil.ebc.com.br",
  "g1.globo.com",
  "esfala.com.br"
];

const BLOCK_TERMS = [
  "assista","ao vivo","video","vídeo","veja","urgente",
  "morre","morte","assassin","homic","tirote","balead",
  "estupro","tragédia","explos","incênd","enchent"
];

const ES_WORDS = [
  "espírito santo","espirito santo",
  " es ","- es","/es","es/",
  "prefeitura","governo do estado","governo do es","secretaria estadual",
  "defesa civil es","detran es","sedu es","ses es"
];

/* ===== CLOCK ===== */
const clock = document.getElementById("clock");
function tickClock(){
  clock.textContent = new Date().toLocaleTimeString("pt-BR",{hour:"2-digit",minute:"2-digit"});
}
tickClock();
setInterval(tickClock, 1000);

/* ===== ONLINE / OFFLINE ===== */
const statusText = document.getElementById("statusText");
const dot = document.getElementById("dot");
function updateStatus(){
  if(navigator.onLine){
    statusText.textContent="Online"; dot.classList.remove("off");
  }else{
    statusText.textContent="Offline"; dot.classList.add("off");
  }
}
updateStatus();
window.addEventListener("online",updateStatus);
window.addEventListener("offline",updateStatus);

/* ===== HELPERS ===== */
function norm(s){
  return (s||"").toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"");
}
function host(u){
  try{return new URL(u).hostname.replace("www.","");}catch{return""}
}
function allowedDomain(u){
  const h=host(u);
  return ALLOWED_DOMAINS.some(d=>h===d||h.endsWith("."+d));
}
function recent(d){
  const t=new Date(d).getTime();
  return !isNaN(t) && Date.now()-t <= MAX_DAYS*86400000;
}
function blocked(it){
  const h=norm(it.title+" "+it.link);
  return BLOCK_TERMS.some(w=>h.includes(w));
}
function looksES(it){
  const h=norm(it.title+" "+it.link);
  return ES_WORDS.some(w=>h.includes(norm(w)));
}
function favicon(u){
  try{return "https://www.google.com/s2/favicons?domain="+new URL(u).hostname+"&sz=64"}catch{return""}
}

/* ✅ proxy de imagem (weserv) */
function imgProxy(u){
  if(!u) return null;

  let url = String(u).trim();
  if(!url) return null;

  if(url.startsWith("//")) url = "https:" + url;
  if(!/^https?:\/\//i.test(url)) return null;

  return "https://images.weserv.nl/?url="
    + encodeURIComponent(url.replace(/^https?:\/\//i,""))
    + "&w=1600&h=900&fit=cover&output=webp";
}

/* ===== DATA ===== */
let NEWS=[], idx=0, timer=null;

async function fetchNews(){
  // ✅ a cada refresh/reload, muda seed e evita qualquer cache intermediário
  const seed = String(Date.now());
  const url = `${WORKER_API}?limit=${LIMIT}&safe=${SAFE}&seed=${seed}&_=${seed}`;

  const res = await fetch(url, { cache:"no-store" });
  const j = await res.json();
  if(!j?.items) throw new Error("Sem items");

  return j.items.map(it=>({
    title: it.title || "Notícia",
    link: it.link || "",
    pub: it.pubDate || it.publishedAt || "",
    img: it.image || "",
    fav: favicon(it.link || "")
  }));
}

function applyFilters(list){
  let out=list
    .filter(i=>allowedDomain(i.link))
    .filter(i=>recent(i.pub))
    .filter(i=>!blocked(i));

  // ✅ se houver bastante ES, prioriza ES primeiro (mas não zera Brasil)
  if(out.length){
    const es = out.filter(i=>looksES(i));
    const br = out.filter(i=>!looksES(i));
    if(es.length) out = es.concat(br);
  }
  return out;
}

/* ✅ crossfade na troca */
function render(){
  if(!NEWS.length) return;

  const n = NEWS[idx++ % NEWS.length];
  const contentEl = document.querySelector(".content");
  contentEl.classList.add("fadeOut");

  setTimeout(()=>{
    document.getElementById("title").textContent = n.title;

    const img = imgProxy(n.img);
    const imgEl = document.getElementById("image");
    const hero = document.getElementById("hero");

    if(img){
      hero.classList.remove("noimg");
      imgEl.src = img;
    }else{
      hero.classList.add("noimg");
      imgEl.removeAttribute("src");
    }

    const favEl = document.getElementById("favicon");
    favEl.src = n.fav || "";
    favEl.style.display = n.fav ? "block" : "none";

    const dt = new Date(n.pub);
    const when = isNaN(dt.getTime()) ? "—" : dt.toLocaleString("pt-BR");
    document.getElementById("footMeta").textContent =
      `${host(n.link).toUpperCase()} • ${when}`;

    requestAnimationFrame(()=> contentEl.classList.remove("fadeOut"));
  }, 220);
}

async function refresh(){
  try{
    const raw = await fetchNews();
    NEWS = applyFilters(raw);
    if(!NEWS.length) throw new Error("Sem notícias");

    // ✅ começa aleatório a cada refresh (inclui refresh da página)
    idx = Math.floor(Math.random() * NEWS.length);

    render();

    if(timer) clearInterval(timer);
    if(UI_ROTATE_MS > 0){
      timer = setInterval(render, UI_ROTATE_MS);
    }
  }catch(e){
    document.getElementById("title").textContent="Sem notícias no momento";
    document.getElementById("footMeta").textContent="PONTOVIEW • —";
    console.warn(e);
  }
}

// primeira carga (sempre que abrir/recarregar a página)
refresh();

// recarrega lista a cada X horas (mantém)
setInterval(refresh, UI_REFRESH_HOURS*3600000);
</script>
</body>
</html>
